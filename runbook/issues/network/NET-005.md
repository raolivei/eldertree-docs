---
id: NET-005
title: MetalLB VIP Not Responding (L2 Interface Mismatch)
category: network
severity: critical
symptoms:
  - VIP does not respond to ping
  - Services accessible via NodePort but not LoadBalancer
  - /etc/hosts pointing to VIP but requests timeout
---

# NET-005: MetalLB VIP Not Responding (L2 Interface Mismatch)

## Error Messages (Searchable)

```
ping: 192.168.2.200: No route to host
curl: (7) Failed to connect to grafana.eldertree.local port 443
Request timeout for icmp_seq 0
```

## Symptoms

- MetalLB VIP (192.168.2.200) does not respond to ping
- Services work via NodePort (e.g., port 32474) but not via VIP
- `/etc/hosts` correctly maps hostnames to VIP
- NodePort bypass works: `curl -k https://192.168.2.101:32474`
- MetalLB speakers are running but VIP is unreachable

## Root Cause

MetalLB L2Advertisement was not configured to use the correct network interface. The Raspberry Pi nodes use `wlan0` for the management network (192.168.2.0/24) but MetalLB was attempting to announce on the wrong interface or all interfaces.

**Investigation Output:**

```bash
# Check MetalLB speaker logs
kubectl logs -n metallb-system -l component=speaker | grep -i "announce\|interface"

# Shows ARP announcements but not reaching client
# Interface detection may default to eth0 or internal interfaces
```

## Resolution

### Step 1: Update L2Advertisement to Specify wlan0

Edit MetalLB L2Advertisement to explicitly use `wlan0`:

```yaml
# clusters/eldertree/core-infrastructure/metallb/config.yaml
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: default
  namespace: metallb-system
spec:
  ipAddressPools:
    - default
  interfaces:
    - wlan0  # Explicitly specify the management network interface
```

### Step 2: Apply Configuration

```bash
# Apply the updated config
kubectl apply -f clusters/eldertree/core-infrastructure/metallb/config.yaml

# Force MetalLB speakers to restart
kubectl rollout restart daemonset/metallb-speaker -n metallb-system

# Wait for rollout to complete
kubectl rollout status daemonset/metallb-speaker -n metallb-system
```

### Step 3: Verify VIP is Responding

```bash
# Test VIP connectivity
ping -c 3 192.168.2.200

# Expected output:
# 64 bytes from 192.168.2.200: icmp_seq=0 ttl=64 time=2.xxx ms

# Test service via VIP
curl -k https://192.168.2.200/health
```

## Network Architecture Reference

```
Nodes:
├── node-1: 192.168.2.101 (wlan0), 10.0.0.1 (eth0)
├── node-2: 192.168.2.102 (wlan0), 10.0.0.2 (eth0)
└── node-3: 192.168.2.103 (wlan0), 10.0.0.3 (eth0)

MetalLB VIPs (L2 Mode on wlan0):
├── 192.168.2.200 - Traefik Ingress (HTTPS for all services)
├── 192.168.2.201 - Pi-hole (DNS)
└── 192.168.2.202 - Reserved for WireGuard
```

## Prevention

When configuring MetalLB L2 mode on multi-interface nodes:

1. **Always specify interfaces** in L2Advertisement
2. **Use the management network interface** (wlan0 for WiFi, eth0 for wired)
3. **Avoid internal k3s interfaces** (flannel.1, cni0, vethXXX)
4. **Test VIP immediately** after MetalLB configuration changes

## Verification Commands

```bash
# Check MetalLB speaker status
kubectl get pods -n metallb-system -o wide

# Check L2Advertisement configuration
kubectl get l2advertisement -n metallb-system -o yaml

# Check VIP assignment
kubectl get svc -A | grep LoadBalancer

# Check ARP entries on client Mac
arp -a | grep 192.168.2.200

# Check MetalLB speaker logs for announcements
kubectl logs -n metallb-system -l component=speaker --tail=50
```

## Related Issues

- NET-001: Network connectivity after Netplan configuration
- pi-fleet Issue #49: WireGuard HA with MetalLB

## References

- [MetalLB L2 Configuration](https://metallb.universe.tf/configuration/_advanced_l2_configuration/)
- [pi-fleet NETWORK.md](https://github.com/raolivei/pi-fleet/blob/main/NETWORK.md)
