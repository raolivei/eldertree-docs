---
id: CF-002
title: Cloudflare Origin Certificates Setup
category: cloudflare
severity: medium
date: 2026-01-27
symptoms:
  - 502 Bad Gateway with Full (strict) SSL
  - SSL certificate error
  - Origin certificate expired
  - Self-signed certificate rejected
---

# CF-002: Cloudflare Origin Certificates Setup

## Error Messages (Searchable)

```
502 Bad Gateway
Error 525: SSL handshake failed
Error 526: Invalid SSL certificate
CN=Eldertree Local CA (self-signed not accepted)
```

## Problem

Cloudflare's "Full (strict)" SSL mode requires a valid origin certificate. Self-signed certificates are rejected, causing 502 errors.

## Solution Overview

1. **Generate Origin Certificates via Terraform** - Creates certs for each domain
2. **Store in Vault** - Certificates stored securely
3. **Sync to Kubernetes via ExternalSecrets** - Automatic TLS secret creation
4. **Configure Ingress** - Reference the TLS secrets

## Domains and Certificates

| Domain | Cert Covers | Vault Path |
|--------|-------------|------------|
| eldertree.xyz | `*.eldertree.xyz`, `eldertree.xyz` | `secret/swimto/cloudflare-origin-cert-eldertree` |
| swimto.app | `*.swimto.app`, `swimto.app` | `secret/swimto/cloudflare-origin-cert-app` |
| pitanga.cloud | `*.pitanga.cloud`, `pitanga.cloud` | `secret/pitanga/cloudflare-origin-cert` |

## Setup Steps

### Step 1: Generate Certificates with Terraform

```hcl
# In cloudflare.tf

# Private key
resource "tls_private_key" "eldertree_xyz" {
  count     = local.cloudflare_enabled ? 1 : 0
  algorithm = "RSA"
  rsa_bits  = 2048
}

# Certificate signing request
resource "tls_cert_request" "eldertree_xyz" {
  count           = local.cloudflare_enabled ? 1 : 0
  private_key_pem = tls_private_key.eldertree_xyz[0].private_key_pem
  subject {
    common_name  = "eldertree.xyz"
    organization = "Eldertree"
  }
}

# Origin certificate (valid for 15 years)
resource "cloudflare_origin_ca_certificate" "eldertree_xyz" {
  count              = local.cloudflare_enabled ? 1 : 0
  request_type       = "origin-rsa"
  requested_validity = 5475  # 15 years
  csr                = tls_cert_request.eldertree_xyz[0].cert_request_pem
  hostnames = [
    "eldertree.xyz",
    "*.eldertree.xyz"
  ]
}

# Outputs
output "eldertree_xyz_origin_cert" {
  value     = cloudflare_origin_ca_certificate.eldertree_xyz[0].certificate
  sensitive = true
}

output "eldertree_xyz_origin_key" {
  value     = tls_private_key.eldertree_xyz[0].private_key_pem
  sensitive = true
}
```

### Step 2: Apply Terraform and Store in Vault

```bash
cd ~/WORKSPACE/raolivei/pi-fleet/terraform
export TF_VAR_cloudflare_api_token='your-token'

# Apply terraform
terraform apply

# Get certificate and key
CERT=$(terraform output -raw eldertree_xyz_origin_cert)
KEY=$(terraform output -raw eldertree_xyz_origin_key)

# Store in Vault
export KUBECONFIG=~/.kube/config-eldertree
kubectl exec -n vault vault-1 -- vault kv put secret/swimto/cloudflare-origin-cert-eldertree \
  certificate="$CERT" \
  private-key="$KEY"
```

### Step 3: Create ExternalSecret

```yaml
# cloudflare-origin-cert-eldertree-xyz-external.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: swimto-cloudflare-origin-cert-eldertree
  namespace: swimto
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault
    kind: ClusterSecretStore
  target:
    name: swimto-cloudflare-origin-tls  # Secret name for Ingress
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
      data:
        tls.crt: "{{ .certificate }}"
        tls.key: "{{ .privatekey }}"
  data:
    - secretKey: certificate
      remoteRef:
        key: secret/swimto/cloudflare-origin-cert-eldertree
        property: certificate
    - secretKey: privatekey
      remoteRef:
        key: secret/swimto/cloudflare-origin-cert-eldertree
        property: private-key
```

### Step 4: Configure Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: swimto-web
  namespace: swimto
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - swimto.eldertree.xyz
      secretName: swimto-cloudflare-origin-tls  # References the ExternalSecret target
  rules:
    - host: swimto.eldertree.xyz
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: swimto-web-service
                port:
                  number: 3000
```

## Verification

### Check Certificate is Cloudflare Origin

```bash
kubectl get secret swimto-cloudflare-origin-tls -n swimto \
  -o jsonpath='{.data.tls\.crt}' | base64 -d | openssl x509 -noout -issuer

# Should show:
# issuer=C=US, O=CloudFlare, Inc., OU=CloudFlare Origin SSL Certificate Authority
```

### Check ExternalSecret Status

```bash
kubectl get externalsecret -n swimto

# Should show STATUS=SecretSynced, READY=True
```

### Test Site

```bash
curl -I https://swimto.eldertree.xyz
# Should return 200 OK
```

## Troubleshooting

### 502 After Certificate Update

Traefik may need to be restarted to pick up new certificates:

```bash
kubectl rollout restart deployment traefik -n kube-system
```

### ExternalSecret Shows Error

Check Vault connectivity:

```bash
# Verify Vault is unsealed
kubectl exec -n vault vault-1 -- vault status

# Check ClusterSecretStore
kubectl get clustersecretstore vault -o yaml
```

### Certificate Shows Self-Signed

The ExternalSecret target name must match the Ingress secretName exactly.

## Cloudflare SSL Settings

For these certificates to work, ensure Cloudflare is set to:

- **SSL/TLS Mode:** Full (strict)
- **Always Use HTTPS:** On
- **Minimum TLS Version:** 1.2

## Related Files

- **Terraform:** `pi-fleet/terraform/cloudflare.tf`
- **ExternalSecrets:** `pi-fleet/clusters/eldertree/swimto/cloudflare-origin-cert-*.yaml`
- **Ingress:** `pi-fleet/clusters/eldertree/swimto/ingress.yaml`

## Related Runbooks

- [CF-001: Cloudflare Tunnel Troubleshooting](/runbook/issues/cloudflare/CF-001)
- [VAULT-001: Vault Recovery Guide](/runbook/issues/storage/VAULT-001)
